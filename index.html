<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang="page_title">Formulari Preinscripci√≥ Extraescolars 2025-26 | AFA Escola Falguera</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .form-section { display: none; }
        .form-section.active { display: block; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .lang-btn.active {
            font-weight: bold;
            color: #1d4ed8; /* text-blue-800 */
            background-color: #eff6ff; /* bg-blue-50 */
            border: 2px solid #3b82f6; /* border-blue-500 */
        }
        .lang-btn {
            border: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        /* Modal styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-container {
            transition: transform 0.3s ease;
        }
        /* New Activity Card Styles */
        .activity-card {
            transition: all 0.2s ease-in-out;
            border: 2px solid #e5e7eb; /* border-gray-200 */
        }
        .activity-card.selected {
            border-color: #3b82f6; /* border-blue-500 */
            background-color: #eff6ff; /* bg-blue-50 */
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .activity-card input[type="checkbox"] {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
        
        <div class="flex justify-end items-center mb-4">
            <div class="text-right">
                <button id="lang-ca" class="lang-btn active p-2 flex items-center space-x-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <span class="text-2xl">üá™üá∏</span>
                    <span class="text-sm font-medium">Catal√†</span>
                </button>
                <button id="lang-es" class="lang-btn text-gray-600 p-2 flex items-center space-x-2 hover:bg-gray-100 rounded-lg transition-colors">
                    <span class="text-2xl">üá™üá∏</span>
                    <span class="text-sm font-medium">Espa√±ol</span>
                </button>
            </div>
        </div>

        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-blue-800" data-lang="main_header">AFA Escola Falguera</h1>
            <p class="text-lg sm:text-xl text-gray-600 mt-2" data-lang="main_subheader">Formulari de Preinscripci√≥ per a Activitats Extraescolars 2025-26</p>
        </header>

        <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-lg mb-8 text-center">
            <p class="font-semibold" data-lang="important_info_title">Informaci√≥ important:</p>
            <p class="text-sm" data-lang="important_info_body">Les activitats ofertes nom√©s es duran a terme si hi ha un nombre suficient d'alumnes. En cas que el nombre d'inscrits superi l'aforament m√†xim, es tindr√† en compte l'ordre d'inscripci√≥.</p>
        </div>

        <!-- Main Form -->
        <form id="inscription-form" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg space-y-8">
            
            <!-- Pricing Section -->
             <fieldset>
                <legend class="text-xl font-semibold text-gray-900 border-b-2 border-blue-200 pb-2 mb-4" data-lang="pricing_legend">Preus i M√®tode de Pagament</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-center">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold" data-lang="pricing_general_title">Activitats Generals</h4>
                        <p class="text-sm text-gray-500" data-lang="pricing_general_hours">16:30h a 18:00h</p>
                        <p class="mt-2"><span class="font-bold text-lg text-blue-700">20‚Ç¨</span> <span data-lang="pricing_socis">/mes socis</span></p>
                        <p><span class="font-bold text-lg text-gray-700">25‚Ç¨</span> <span data-lang="pricing_no_socis">/mes no socis</span></p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold" data-lang="pricing_timbals_title">Timbals</h4>
                        <p class="text-sm text-gray-500" data-lang="pricing_timbals_hours">17:30h a 19:00h (Divendres)</p>
                        <p class="mt-2"><span class="font-bold text-lg text-blue-700">14‚Ç¨</span> <span data-lang="pricing_socis">/mes socis</span></p>
                        <p><span class="font-bold text-lg text-gray-700">18‚Ç¨</span> <span data-lang="pricing_no_socis">/mes no socis</span></p>
                    </div>
                </div>
                <div class="mt-4 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">
                    <p><strong data-lang="pricing_discount_title">Descompte:</strong> <span data-lang="pricing_discount_body">Si es realitzen dues extraescolars iguals a la mateixa setmana, el preu final seria 36‚Ç¨ mensuals per a socis, i 40‚Ç¨ mensuals per a NO socis.</span></p>
                </div>
                
                <!-- Important notice for English classes -->
                <div class="mt-4 text-sm text-red-700 bg-red-50 border border-red-200 p-4 rounded-lg">
                    <p class="font-semibold" data-lang="english_payment_notice_title">‚ö†Ô∏è AV√çS IMPORTANT - Classes d'Angl√®s:</p>
                    <p data-lang="english_payment_notice_body">Les classes d'Angl√®s dels dimarts i dimecres NO es paguen a trav√©s de l'AFA. El pagament es gestiona directament amb l'empresa d'angl√®s.</p>
                </div>

                <!-- Payment Info -->
                <div class="mt-6 bg-green-50 border border-green-200 p-4 rounded-lg">
                    <h4 class="font-semibold text-green-800" data-lang="payment_info_title">Informaci√≥ de Pagament</h4>
                    <p class="text-sm text-green-700 mt-2" data-lang="payment_info_body">Totes les activitats s√≥n de pagament mensual per transfer√®ncia banc√†ria abans del dia 10 del mes en curs.</p>
                    <div class="mt-3 flex flex-wrap items-center bg-white p-2 rounded-md border">
                        <span class="font-mono text-gray-800 flex-grow" id="iban-account">ES22 0081 1604 7400 0103 8208</span>
                        <button type="button" id="copy-iban-btn" class="ml-4 bg-green-600 text-white px-3 py-1 text-xs font-semibold rounded-md hover:bg-green-700 transition-colors" data-lang="payment_copy_iban">Copiar IBAN</button>
                    </div>
                    <p class="text-xs text-red-600 font-semibold mt-2" data-lang="payment_info_concept">Important! Indicar al concepte el nom de l'alumne/a i l'activitat.</p>
                </div>
            </fieldset>

            <!-- Students Data -->
            <fieldset>
                <legend class="text-xl font-semibold text-gray-900 border-b-2 border-blue-200 pb-2 mb-4" data-lang="students_data_legend">Dades dels Alumnes</legend>
                
                <!-- Student 1 -->
                <div id="student-1-section" class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h4 class="font-semibold text-blue-800 mb-4" data-lang="student_1_title">Alumne/a 1</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="student1-name" class="block text-sm font-medium text-gray-700" data-lang="student_name">Nom</label>
                            <input type="text" id="student1-name" name="student1_name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="student1-surname" class="block text-sm font-medium text-gray-700" data-lang="student_surname">Cognoms</label>
                            <input type="text" id="student1-surname" name="student1_surname" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="student1-course" class="block text-sm font-medium text-gray-700" data-lang="student_course">Curs <span class="text-red-500">*</span></label>
                            <select id="student1-course" name="student1_course" required class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled selected data-lang="select_course">Selecciona un curs</option>
                                <option value="I3">I3</option><option value="I4">I4</option><option value="I5">I5</option>
                                <option value="1PRI" data-lang="course_1pri">1r Prim√†ria</option><option value="2PRI" data-lang="course_2pri">2n Prim√†ria</option><option value="3PRI" data-lang="course_3pri">3r Prim√†ria</option>
                                <option value="4PRI" data-lang="course_4pri">4t Prim√†ria</option><option value="5PRI" data-lang="course_5pri">5√® Prim√†ria</option><option value="6PRI" data-lang="course_6pri">6√® Prim√†ria</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Add Second Student Button -->
                <div class="text-center mb-4">
                    <button type="button" id="add-second-student" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors" data-lang="add_second_student">
                        + Afegir segon alumne/a
                    </button>
                </div>

                <!-- Student 2 (Hidden by default) -->
                <div id="student-2-section" class="bg-green-50 p-4 rounded-lg mb-4 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="font-semibold text-green-800" data-lang="student_2_title">Alumne/a 2</h4>
                        <button type="button" id="remove-second-student" class="text-red-600 hover:text-red-800 text-sm" data-lang="remove_student">
                            ‚úï Eliminar
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="student2-name" class="block text-sm font-medium text-gray-700" data-lang="student_name">Nom</label>
                            <input type="text" id="student2-name" name="student2_name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="student2-surname" class="block text-sm font-medium text-gray-700" data-lang="student_surname">Cognoms</label>
                            <input type="text" id="student2-surname" name="student2_surname" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="student2-course" class="block text-sm font-medium text-gray-700" data-lang="student_course">Curs</label>
                            <select id="student2-course" name="student2_course" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="" disabled selected data-lang="select_course">Selecciona un curs</option>
                                <option value="I3">I3</option><option value="I4">I4</option><option value="I5">I5</option>
                                <option value="1PRI" data-lang="course_1pri">1r Prim√†ria</option><option value="2PRI" data-lang="course_2pri">2n Prim√†ria</option><option value="3PRI" data-lang="course_3pri">3r Prim√†ria</option>
                                <option value="4PRI" data-lang="course_4pri">4t Prim√†ria</option><option value="5PRI" data-lang="course_5pri">5√® Prim√†ria</option><option value="6PRI" data-lang="course_6pri">6√® Prim√†ria</option>
                            </select>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- Activities Section -->
            <fieldset>
                <legend class="text-xl font-semibold text-gray-900 border-b-2 border-blue-200 pb-2 mb-4" data-lang="activities_legend">Activitats Extraescolars</legend>
                <p class="text-sm text-gray-600 mb-4" data-lang="activities_subtitle">Selecciona les activitats desitjades per a cada alumne/a (m√≠nim una). Les opcions apareixeran quan tri√Øs un curs.</p>
                
                <!-- Student 1 Activities -->
                <div id="student1-activities" class="mb-6">
                    <h4 class="font-semibold text-blue-800 mb-4" data-lang="student1_activities_title">Activitats per a l'Alumne/a 1</h4>
                    <div id="activities-infantil-1" class="form-section space-y-4">
                        <h5 class="font-medium text-gray-700" data-lang="infantil_options">Opcions per a Infantil (I3-I5)</h5>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4"></div>
                    </div>
                    <div id="activities-primaria1-1" class="form-section space-y-4">
                        <h5 class="font-medium text-gray-700" data-lang="primaria1_options">Opcions per a 1r, 2n i 3r de Prim√†ria</h5>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4"></div>
                    </div>
                    <div id="activities-primaria2-1" class="form-section space-y-4">
                        <h5 class="font-medium text-gray-700" data-lang="primaria2_options">Opcions per a 4t, 5√® i 6√® de Prim√†ria</h5>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4"></div>
                    </div>
                </div>

                <!-- Student 2 Activities (Hidden by default) -->
                <div id="student2-activities" class="mb-6 hidden">
                    <h4 class="font-semibold text-green-800 mb-4" data-lang="student2_activities_title">Activitats per a l'Alumne/a 2</h4>
                    <div id="activities-infantil-2" class="form-section space-y-4">
                        <h5 class="font-medium text-gray-700" data-lang="infantil_options">Opcions per a Infantil (I3-I5)</h5>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4"></div>
                    </div>
                    <div id="activities-primaria1-2" class="form-section space-y-4">
                        <h5 class="font-medium text-gray-700" data-lang="primaria1_options">Opcions per a 1r, 2n i 3r de Prim√†ria</h5>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4"></div>
                    </div>
                    <div id="activities-primaria2-2" class="form-section space-y-4">
                        <h5 class="font-medium text-gray-700" data-lang="primaria2_options">Opcions per a 4t, 5√® i 6√® de Prim√†ria</h5>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3 md:gap-4"></div>
                    </div>
                </div>
            </fieldset>

            <!-- Parent/Guardian Data -->
            <fieldset>
                <legend class="text-xl font-semibold text-gray-900 border-b-2 border-blue-200 pb-2 mb-4" data-lang="parent_data_legend">Dades del Pare/Mare/Tutor/a</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="parent-name" class="block text-sm font-medium text-gray-700" data-lang="parent_name">Nom i Cognoms</label>
                        <input type="text" id="parent-name" name="parent_name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div>
                        <label for="parent-dni" class="block text-sm font-medium text-gray-700" data-lang="parent_dni">DNI/NIF</label>
                        <input type="text" id="parent-dni" name="parent_dni" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="parent-phone-1" class="block text-sm font-medium text-gray-700" data-lang="parent_phone_1">Tel√®fon de Contacte 1 <span class="text-red-500">*</span></label>
                        <input type="tel" id="parent-phone-1" name="parent_phone_1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="parent-phone-2" class="block text-sm font-medium text-gray-700" data-lang="parent_phone_2">Tel√®fon de Contacte 2 <span class="text-gray-400" data-lang="optional">(Opcional)</span></label>
                        <input type="tel" id="parent-phone-2" name="parent_phone_2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="parent-email-1" class="block text-sm font-medium text-gray-700" data-lang="parent_email_1">Email de Contacte 1 <span class="text-red-500">*</span></label>
                        <input type="email" id="parent-email-1" name="parent_email_1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="parent-email-2" class="block text-sm font-medium text-gray-700" data-lang="parent_email_2">Email de Contacte 2 <span class="text-gray-400" data-lang="optional">(Opcional)</span></label>
                        <input type="email" id="parent-email-2" name="parent_email_2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700" data-lang="afa_member_question">Sou socis de l'AFA? <span class="text-red-500">*</span></label>
                        <div class="mt-2 flex items-center space-x-4">
                            <label class="flex items-center"><input type="radio" name="afa_member" value="true" required class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mr-2"><span data-lang="yes">S√≠</span></label>
                            <label class="flex items-center"><input type="radio" name="afa_member" value="false" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mr-2"><span data-lang="no">No</span></label>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- Health & Authorizations -->
            <fieldset>
                 <legend class="text-xl font-semibold text-gray-900 border-b-2 border-blue-200 pb-2 mb-4" data-lang="auth_legend">Informaci√≥ Addicional i Autoritzacions</legend>
                 <div>
                    <label for="health-info" class="block text-sm font-medium text-gray-700" data-lang="health_question">L'alumne/a t√© alguna malaltia cr√≤nica, al¬∑l√®rgia o pren medicaci√≥?</label>
                    <textarea id="health-info" name="health_info" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" data-lang-placeholder="health_placeholder"></textarea>
                 </div>
                 
                 <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700">
                        <span data-lang="image_auth_title">Autoritzaci√≥ de drets d'imatge</span> <span class="text-red-500">*</span>
                        <button type="button" id="image-info-btn" class="ml-2 text-blue-600 hover:text-blue-800 font-bold">(i)</button>
                    </label>
                    <p class="text-xs text-gray-500 mb-2" data-lang="image_auth_subtitle">Per a l'√∫s d'imatges en fotografies i/o v√≠deos realitzats per l'AFA amb la finalitat d'exposar-les a la nostra web i xarxes socials.</p>
                    <div class="mt-2 flex items-center space-x-4">
                        <label class="flex items-center"><input type="radio" name="image_auth_consent" value="si" required class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mr-2"><span data-lang="image_auth_yes">S√≠, autoritzo el tractament de la imatge.</span></label>
                        <label class="flex items-center"><input type="radio" name="image_auth_consent" value="no" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mr-2"><span data-lang="image_auth_no">No, no autoritzo el tractament de la imatge.</span></label>
                    </div>
                 </div>

                 <div class="mt-6">
                    <label class="block text-sm font-medium text-gray-700" data-lang="exit_auth_title">Autoritzaci√≥ de sortida de l'activitat <span class="text-red-500">*</span></label>
                     <div class="mt-2">
                         <p class="text-sm text-gray-700 mb-2" data-lang="exit_auth_question">L'alumne/a pot marxar sol/sola en finalitzar l'activitat extraescolar?</p>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center"><input type="radio" name="can_leave_alone" value="true" required class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mr-2"><span data-lang="yes">S√≠</span></label>
                            <label class="flex items-center"><input type="radio" name="can_leave_alone" value="false" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500 mr-2"><span data-lang="no">No</span></label>
                        </div>
                     </div>
                     <div class="mt-4">
                        <label for="authorized_pickup" class="block text-sm font-medium text-gray-700" data-lang="authorized_pickup_label">Persones autoritzades a recollir l'infant (Nom, Cognoms i DNI)</label>
                        <textarea id="authorized_pickup" name="authorized_pickup" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" data-lang-placeholder="authorized_pickup_placeholder"></textarea>
                     </div>
                 </div>

                 <div class="mt-6 space-y-4">
                    <div class="flex items-start">
                        <input id="conditions-accepted" name="conditions_accepted" type="checkbox" required class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-1">
                        <label for="conditions-accepted" class="ml-3 block text-sm text-gray-700"><span data-lang="conditions_accepted_label">He llegit i accepto les</span> <button type="button" id="conditions-btn" class="text-blue-600 hover:underline font-medium" data-lang="conditions_link">condicions de les extraescolars i acollida</button>. <span class="text-red-500">*</span></label>
                    </div>
                 </div>
            </fieldset>
            
            <!-- Submission -->
            <div class="pt-4">
                <button type="submit" id="submit-button" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400">
                    <span id="submit-text" data-lang="submit_button">Enviar Preinscripci√≥</span>
                    <div id="submit-loader" class="loader hidden"></div>
                </button>
            </div>
        </form>

        <!-- Status Messages -->
        <div id="status-message" class="mt-6 text-center"></div>
    </div>

    <!-- Modal Structure -->
    <div id="info-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center p-4 z-50 modal-overlay hidden opacity-0">
        <div class="relative mx-auto shadow-lg rounded-md bg-white w-full max-w-2xl modal-container transform scale-95">
            <div class="p-6">
                <div class="flex justify-between items-start">
                    <h3 id="modal-title" class="text-2xl font-semibold text-gray-900"></h3>
                    <button id="modal-close-btn" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div id="modal-content" class="mt-4 text-sm text-gray-600 space-y-3 max-h-[60vh] overflow-y-auto">
                    <!-- Content will be injected by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const { createClient } = supabase;
        let supabaseClient;
        let currentLang = 'ca';

        // =================================================================================
        // == PAS 1: CONFIGURACI√ì DE SUPABASE                                             ==
        // == Enganxa aqu√≠ la teva URL i la teva Anon Key de Supabase.                    ==
        // == Aquestes dades les trobar√†s a 'Project Settings' > 'API' del teu projecte.  ==
        // =================================================================================
        const SUPABASE_URL = "https://zaxbtnjkidqwzqsehvld.supabase.co"; // <-- ENGANXA AQU√ç LA TEVA URL
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpheGJ0bmpraWRxd3pxc2VodmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMjc2NTMsImV4cCI6MjA3MzYwMzY1M30.9MNjQdeLvW_UaxZz0XQmR6jQSakzF-UzBWvdboWWHRg"; // <-- ENGANXA AQU√ç LA TEVA ANON KEY


        const allActivities = {
             infantil: [
                { value: "Marxa-Marxa (Dilluns)", langKey: 'activity_marxa_dl', dayLangKey: 'day_dl', schedule: '16:30 - 18:00' },
                { value: "Teatre Musical en Angl√®s (Dimarts)", langKey: 'activity_teatre_musical_dm', dayLangKey: 'day_dm', schedule: '16:30 - 18:00' },
                { value: "Teatre Musical en Angl√®s (Dimecres)", langKey: 'activity_teatre_musical_dc', dayLangKey: 'day_dc', schedule: '16:30 - 18:00' },
                { value: "Marxa-Marxa (Dijous)", langKey: 'activity_marxa_dj', dayLangKey: 'day_dj', schedule: '16:30 - 18:00' },
                { value: "Iniciaci√≥ a Timbals (Divendres)", langKey: 'activity_timbals_iniciacio_dv', dayLangKey: 'day_dv', schedule: '16:30 - 18:00' },
            ],
            primaria1: [
                { value: "Teatre amb Angl√®s (Dilluns)", langKey: 'activity_teatre_dl', dayLangKey: 'day_dl', schedule: '16:30 - 18:00' },
                { value: "Hip Hop (Dilluns)", langKey: 'activity_hiphop_dl', dayLangKey: 'day_dl', schedule: '16:30 - 18:00' },
                { value: "Futbol (Dimarts)", langKey: 'activity_futbol_dm', dayLangKey: 'day_dm', schedule: '16:30 - 18:00' },
                { value: "Angl√®s (Dimecres)", langKey: 'activity_angles_dc', dayLangKey: 'day_dc', schedule: '16:30 - 17:45' },
                { value: "Teatre amb Angl√®s (Dimecres)", langKey: 'activity_teatre_dc', dayLangKey: 'day_dc', schedule: '16:30 - 18:00'},
                { value: "Patinatge (Dimecres)", langKey: 'activity_patinatge_dc', dayLangKey: 'day_dc', schedule: '16:30 - 18:00' },
                { value: "Basket (Dimecres)", langKey: 'activity_basket_dc', dayLangKey: 'day_dc', schedule: '16:30 - 18:00' },
                { value: "Futbol (Dijous)", langKey: 'activity_futbol_dj', dayLangKey: 'day_dj', schedule: '16:30 - 18:00' },
                { value: "Iniciaci√≥ Timbals (Divendres)", langKey: 'activity_timbals_iniciacio_dv', dayLangKey: 'day_dv', schedule: '16:30 - 18:00' },
                { value: "Timbals (Divendres)", langKey: 'activity_timbals_dv', dayLangKey: 'day_dv', schedule: '16:30 - 18:00' },
            ],
            primaria2: [
                { value: "Teatre amb Angl√®s (Dilluns)", langKey: 'activity_teatre_dl', dayLangKey: 'day_dl', schedule: '16:30 - 18:00' },
                { value: "Hip Hop (Dilluns)", langKey: 'activity_hiphop_dl', dayLangKey: 'day_dl', schedule: '16:30 - 18:00' },
                { value: "Angl√®s (Dimarts)", langKey: 'activity_angles_dt', dayLangKey: 'day_dt', schedule: '16:30 - 17:45' },
                { value: "Futbol (Dimarts)", langKey: 'activity_futbol_dm', dayLangKey: 'day_dm', schedule: '16:30 - 18:00' },
                { value: "Teatre amb Angl√®s (Dimecres)", langKey: 'activity_teatre_dc', dayLangKey: 'day_dc', schedule: '16:30 - 18:00' },
                { value: "Patinatge (Dimecres)", langKey: 'activity_patinatge_dc', dayLangKey: 'day_dc', schedule: '16:30 - 18:00' },
                { value: "Basket (Dimecres)", langKey: 'activity_basket_dc', dayLangKey: 'day_dc', schedule: '16:30 - 18:00' },
                { value: "Futbol (Dijous)", langKey: 'activity_futbol_dj', dayLangKey: 'day_dj', schedule: '16:30 - 18:00' },
                { value: "Timbals (Divendres)", langKey: 'activity_timbals_dv', dayLangKey: 'day_dv', schedule: '16:30 - 18:00' },
            ]
        };

        const translations = {
            ca: {
                page_title: "Formulari Preinscripci√≥ Extraescolars 2025-26 | AFA Escola Falguera",
                main_header: "AFA Escola Falguera",
                main_subheader: "Formulari de Preinscripci√≥ per a Activitats Extraescolars 2025-26",
                important_info_title: "Informaci√≥ important:",
                important_info_body: "Les activitats ofertes nom√©s es duran a terme si hi ha un nombre suficient d'alumnes. En cas que el nombre d'inscrits superi l'aforament m√†xim, es tindr√† en compte l'ordre d'inscripci√≥.",
                pricing_legend: "Preus i M√®tode de Pagament",
                pricing_general_title: "Activitats Generals",
                pricing_general_hours: "16:30h a 18:00h",
                pricing_socis: "/mes socis",
                pricing_no_socis: "/mes no socis",
                pricing_timbals_title: "Timbals",
                pricing_timbals_hours: "17:30h a 19:00h (Divendres)",
                pricing_discount_title: "Descompte:",
                pricing_discount_body: "Si es realitzen dues extraescolars iguals a la mateixa setmana, el preu final seria 36‚Ç¨ mensuals per a socis, i 40‚Ç¨ mensuals per a NO socis.",
                english_payment_notice_title: "‚ö†Ô∏è AV√çS IMPORTANT - Classes d'Angl√®s:",
                english_payment_notice_body: "Les classes d'Angl√®s dels dimarts i dimecres NO es paguen a trav√©s de l'AFA. El pagament es gestiona directament amb l'empresa d'angl√®s.",
                english_payment_warning: "‚ö†Ô∏è No es paga per AFA",
                payment_info_title: "Informaci√≥ de Pagament",
                payment_info_body: "Totes les activitats s√≥n de pagament mensual per transfer√®ncia banc√†ria abans del dia 10 del mes en curs.",
                payment_copy_iban: "Copiar IBAN",
                payment_copied_iban: "Copiat!",
                payment_info_concept: "Important! Indicar al concepte el nom de l'alumne/a i l'activitat.",
                students_data_legend: "Dades dels Alumnes",
                student_1_title: "Alumne/a 1",
                student_2_title: "Alumne/a 2",
                add_second_student: "+ Afegir segon alumne/a",
                remove_student: "‚úï Eliminar",
                student_name: "Nom",
                student_surname: "Cognoms",
                student_course: "Curs",
                select_course: "Selecciona un curs",
                course_1pri: "1r Prim√†ria", course_2pri: "2n Prim√†ria", course_3pri: "3r Prim√†ria", course_4pri: "4t Prim√†ria", course_5pri: "5√® Prim√†ria", course_6pri: "6√® Prim√†ria",
                activities_legend: "Activitats Extraescolars",
                activities_subtitle: "Selecciona les activitats desitjades per a cada alumne/a (m√≠nim una). Les opcions apareixeran quan tri√Øs un curs.",
                student1_activities_title: "Activitats per a l'Alumne/a 1",
                student2_activities_title: "Activitats per a l'Alumne/a 2",
                infantil_options: "Opcions per a Infantil (I3-I5)",
                primaria1_options: "Opcions per a 1r, 2n i 3r de Prim√†ria",
                primaria2_options: "Opcions per a 4t, 5√® i 6√® de Prim√†ria",
                activity_marxa_dl: "Marxa-Marxa", activity_marxa_dj: "Marxa-Marxa", activity_teatre_musical_dm: "Teatre Musical en Angl√®s", activity_teatre_musical_dc: "Teatre Musical en Angl√®s", activity_timbals_iniciacio_dv: "Iniciaci√≥ a Timbals",
                activity_teatre_dl: "Teatre amb Angl√®s", activity_hiphop_dl: "Hip Hop", activity_futbol_dm: "Futbol", activity_patinatge_dc: "Patinatge", activity_basket_dc: "B√†squet", activity_futbol_dj: "Futbol", activity_timbals_dv: "Timbals", activity_teatre_dc: "Teatre amb Angl√®s", activity_angles_dt: "Angl√®s", activity_angles_dc: "Angl√®s",
                day_dl: "Dilluns", day_dt: "Dimarts", day_dc: "Dimecres", day_dj: "Dijous", day_dv: "Divendres",
                parent_data_legend: "Dades del Pare/Mare/Tutor/a",
                parent_name: "Nom i Cognoms", parent_dni: "DNI/NIF", parent_phone_1: "Tel√®fon de Contacte 1", parent_phone_2: "Tel√®fon de Contacte 2", parent_email_1: "Email de Contacte 1", parent_email_2: "Email de Contacte 2",
                optional: "(Opcional)",
                afa_member_question: "Sou socis de l'AFA?",
                yes: "S√≠", no: "No",
                auth_legend: "Informaci√≥ Addicional i Autoritzacions",
                health_question: "L'alumne/a t√© alguna malaltia cr√≤nica, al¬∑l√®rgia o pren medicaci√≥?",
                health_placeholder: "Si no hi ha res a indicar, deixa-ho en blanc.",
                image_auth_title: "Autoritzaci√≥ de drets d'imatge",
                image_auth_subtitle: "Per a l'√∫s d'imatges en fotografies i/o v√≠deos realitzats per l'AFA amb la finalitat d'exposar-les a la nostra web i xarxes socials.",
                image_auth_yes: "S√≠, autoritzo el tractament de la imatge.", image_auth_no: "No, no autoritzo el tractament de la imatge.",
                exit_auth_title: "Autoritzaci√≥ de sortida de l'activitat",
                exit_auth_question: "L'alumne/a pot marxar sol/sola en finalitzar l'activitat extraescolar?",
                authorized_pickup_label: "Persones autoritzades a recollir l'infant (Nom, Cognoms i DNI)",
                authorized_pickup_placeholder: "Si pot marxar sol/a, o nom√©s el recullen els tutors legals, deixa aquest camp en blanc.",
                conditions_accepted_label: "He llegit i accepto les",
                conditions_link: "condicions de les extraescolars i acollida",
                submit_button: "Enviar Preinscripci√≥",
                status_success: "Preinscripci√≥ enviada correctament! Gr√†cies.",
                status_error_supabase_credentials: "Error de configuraci√≥. Contacta amb l'administrador.",
                status_error_activity_required: "Has de seleccionar almenys una activitat extraescolar.",
                status_error_generic: "Error en enviar el formulari: {error}. Si us plau, intenta-ho de nou m√©s tard.",
                image_auth_modal_title: "Informaci√≥ sobre Drets d'Imatge",
                image_auth_modal_content: `<p>En compliment de la Llei Org√†nica 1/1982, del 5 de maig, sobre el dret a l‚Äôhonor, a la intimitat personal i familiar i a la pr√≤pia imatge demanem autoritzaci√≥ als pares o tutors legals dels menors d‚Äôedat per a l‚Äô√∫s de la imatge obtinguda amb fotografies i/o v√≠deos realitzats per la nostra entitat amb la finalitat d‚Äôexposar-les a la nostra web, al facebook i instagram.</p><p>Sol¬∑licitem el consentiment i autoritzaci√≥ a l‚ÄôAFA Escola Falguera, a fer √∫s de la imatges obtingudes durant la seva participaci√≥ en les activitats extraescolars, publicades a la pagina web o xarxes socials.</p><p>A partir de la signatura d‚Äôaquest formulari vost√® autoritza expressament el tractament de les seves dades de car√†cter personal, per a la finalitat especificada, per part de l'AFA Escola Falguera.</p>`,
                conditions_modal_title: "Condicions de les Extraescolars i Acollida",
                conditions_modal_content: `<div class="space-y-3">
                    <h4 class="font-bold text-base">Preus i Pagament</h4>
                    <ul class="list-disc list-inside text-sm">
                        <li>Activitats Generals (16:30h a 18:00h): <strong>20‚Ç¨/mes socis</strong>, <strong>25‚Ç¨/mes no socis</strong>.</li>
                        <li>Timbals: <strong>14‚Ç¨/mes socis</strong>, <strong>18‚Ç¨/mes no socis</strong>.</li>
                        <li>Descompte 2 activitats/setmana (mateixa activitat): <strong>36‚Ç¨/mes socis</strong>, <strong>40‚Ç¨/mes no socis</strong>.</li>
                        <li>El pagament √©s mensual, per transfer√®ncia banc√†ria al compte <strong>ES22.0081.1604.7400.0103.8208</strong> abans del dia 10 del mes.</li>
                        <li class="font-semibold text-red-600">Important: Indicar al concepte el nom de l'alumne/a i l'activitat.</li>
                    </ul>
                    <h4 class="font-bold text-base pt-2">Condicions Generals</h4>
                    <ol class="list-decimal list-inside space-y-2 text-sm">
                    <li>Per poder accedir a les extraescolars o acollida amb el preu de soci, heu d'estar al corrent del pagament de la quota de l'AFA.</li>
                    <li>La inscripci√≥ de l'alumne en l'activitat es formalitzar√† lliurant el formulari d'inscripci√≥ directament a l'AFA, o b√© per correu electr√≤nic a ampafalguera@hotmail.es, degudament emplenat i signat, conjuntament amb la declaraci√≥ responsable.</li>
                    <li>A partir de setembre les sol¬∑licituts d'alta i de baixa de les activitats proposades hauran de lliurar-se a l'AFA abans del dia 20 del mes en curs (una vegada depassat aquest termini, la baixa NO ser√† efectiva fins al mes seg√ºent i s'haur√† d'abonar la quota corresponent). Es poden enviar via e-mail o presencialment a la oficina de l'AFA.</li>
                    <li>Totes les activitats son de pagament mensual, amb transfer√®ncia banc√†ria al compte del Banc Sabadell ES22.0081.1604.7400.0103.8208 abans del dia 10 del mes en curs. Important! Indicar al concepte nom de l'alumne i activitat.</li>
                    <li>Si no hi hagu√©s un nombre m√≠nim d'alumnes, l'activitat no es podr√† realitzar i s'oferiran alternatives en la mesura que sigui possible.</li>
                    <li>Si les sol¬∑licituts superen el nombre de places ofertes, es tindr√† en compte l'ordre d'inscripci√≥.</li>
                    <li>No es descomptar√† del preu ni es recuperar√† la no assist√®ncia dels alumnes, ni els dies de vacances i festius segons el calendari escolar. No obstant aix√≤, si s√≥n recuperables els dies de classe no impartits per causes atribu√Øbles a l'empresa d'extraescolars.</li>
                    <li>Els impagaments que es produeixin causaran la baixa de l'alumne en totes les activitats extraescolars.</li>
                    <li>√âs obligaci√≥ dels pares/tutors advertir al formulari d'inscripci√≥ de qualsevol malaltia, al¬∑l√®rgia o intoler√†ncia que l'alumne pogu√©s patir.</li>
                    <li>Les persones autoritzades per recollir a l'alumne de las extraescolars o acollida, seran el pares/mares/tutors/es i persones autoritzades que figuren al formulari d'inscripci√≥.</li>
                    <li>S'ha de respectar tan a la persona responsable de l'activitat, com als companys i companyes, materials i infraestructures. De no ser aix√≠, l'AFA podr√† decidir juntament amb l'empresa d'extraescolars, si alg√∫ ha d'abandonar el grup, a fi de preservar la bona marxa i el bon funcionament de l'activitat.</li>
                    <li>Els usuaris de beques confirmades, hauran d'informar a l'AFA marcant la casella al formulari d'incripci√≥, i lliurant el document corresponent.</li>
                    <li>Les preinscripcions es faran del 10 al 14 de juny i del 10 al 20 de setembre.</li>
                </ol></div>`
            },
            es: {
                page_title: "Formulario Preinscripci√≥n Extraescolares 2025-26 | AFA Escola Falguera",
                main_header: "AFA Escola Falguera",
                main_subheader: "Formulario de Preinscripci√≥n para Actividades Extraescolares 2025-26",
                important_info_title: "Informaci√≥n importante:",
                important_info_body: "Las actividades ofrecidas solo se llevar√°n a cabo si hay un n√∫mero suficiente de alumnos. En caso de que el n√∫mero de inscritos supere el aforo m√°ximo, se tendr√° en cuenta el orden de inscripci√≥n.",
                pricing_legend: "Precios y M√©todo de Pago",
                pricing_general_title: "Actividades Generales",
                pricing_general_hours: "16:30h a 18:00h",
                pricing_socis: "/mes socios",
                pricing_no_socis: "/mes no socios",
                pricing_timbals_title: "Timbales",
                pricing_timbals_hours: "17:30h a 19:00h (Viernes)",
                pricing_discount_title: "Descuento:",
                pricing_discount_body: "Si se realizan dos extraescolares iguales en la misma semana, el precio final ser√≠a 36‚Ç¨ mensuales para socios, y 40‚Ç¨ mensuales para NO socios.",
                english_payment_notice_title: "‚ö†Ô∏è AVISO IMPORTANTE - Clases de Ingl√©s:",
                english_payment_notice_body: "Las clases de Ingl√©s de los martes y mi√©rcoles NO se pagan a trav√©s del AFA. El pago se gestiona directamente con la empresa de ingl√©s.",
                english_payment_warning: "‚ö†Ô∏è No se paga por AFA",
                payment_info_title: "Informaci√≥n de Pago",
                payment_info_body: "Todas las actividades son de pago mensual por transferencia bancaria antes del d√≠a 10 del mes en curso.",
                payment_copy_iban: "Copiar IBAN",
                payment_copied_iban: "¬°Copiado!",
                payment_info_concept: "¬°Importante! Indicar en el concepto el nombre del alumno/a y la actividad.",
                students_data_legend: "Datos de los Alumnos",
                student_1_title: "Alumno/a 1",
                student_2_title: "Alumno/a 2",
                add_second_student: "+ A√±adir segundo alumno/a",
                remove_student: "‚úï Eliminar",
                student_name: "Nombre", student_surname: "Apellidos", student_course: "Curso",
                select_course: "Selecciona un curso",
                course_1pri: "1¬∫ Primaria", course_2pri: "2¬∫ Primaria", course_3pri: "3¬∫ Primaria", course_4pri: "4¬∫ Primaria", course_5pri: "5¬∫ Primaria", course_6pri: "6¬∫ Primaria",
                activities_legend: "Actividades Extraescolares",
                activities_subtitle: "Selecciona las actividades deseadas para cada alumno/a (m√≠nimo una). Las opciones aparecer√°n al elegir un curso.",
                student1_activities_title: "Actividades para el Alumno/a 1",
                student2_activities_title: "Actividades para el Alumno/a 2",
                infantil_options: "Opciones para Infantil (I3-I5)",
                primaria1_options: "Opciones para 1¬∫, 2¬∫ y 3¬∫ de Primaria",
                primaria2_options: "Opciones para 4¬∫, 5¬∫ y 6¬∫ de Primaria",
                activity_marxa_dl: "Marcha-Marcha", activity_marxa_dj: "Marcha-Marcha", activity_teatre_musical_dm: "Teatro Musical en Ingl√©s", activity_teatre_musical_dc: "Teatro Musical en Ingl√©s", activity_timbals_iniciacio_dv: "Iniciaci√≥n a Timbales",
                activity_teatre_dl: "Teatro con Ingl√©s", activity_hiphop_dl: "Hip Hop", activity_futbol_dm: "F√∫tbol", activity_patinatge_dc: "Patinaje", activity_basket_dc: "Baloncesto", activity_futbol_dj: "F√∫tbol", activity_timbals_dv: "Timbales", activity_teatre_dc: "Teatro con Ingl√©s", activity_angles_dt: "Ingl√©s", activity_angles_dc: "Ingl√©s",
                day_dl: "Lunes", day_dt: "Martes", day_dc: "Mi√©rcoles", day_dj: "Jueves", day_dv: "Viernes",
                parent_data_legend: "Datos del Padre/Madre/Tutor/a",
                parent_name: "Nombre y Apellidos", parent_dni: "DNI/NIF", parent_phone_1: "Tel√©fono de Contacto 1", parent_phone_2: "Tel√©fono de Contacto 2", parent_email_1: "Email de Contacto 1", parent_email_2: "Email de Contacto 2",
                optional: "(Opcional)",
                afa_member_question: "¬øSois socios del AFA?",
                yes: "S√≠", no: "No",
                auth_legend: "Informaci√≥n Adicional y Autorizaciones",
                health_question: "¬øEl/la alumno/a tiene alguna enfermedad cr√≥nica, alergia o toma medicaci√≥n?",
                health_placeholder: "Si no hay nada que indicar, d√©jalo en blanco.",
                image_auth_title: "Autorizaci√≥n de derechos de imagen",
                image_auth_subtitle: "Para el uso de im√°genes en fotograf√≠as y/o v√≠deos realizados por el AFA con el fin de exponerlas en nuestra web y redes sociales.",
                image_auth_yes: "S√≠, autorizo el tratamiento de la imagen.", image_auth_no: "No, no autorizo el tratamiento de la imagen.",
                exit_auth_title: "Autorizaci√≥n de salida de la actividad",
                exit_auth_question: "¬øEl/la alumno/a puede irse solo/a al finalizar la actividad extraescolar?",
                authorized_pickup_label: "Personas autorizadas a recoger al ni√±o/a (Nombre, Apellidos y DNI)",
                authorized_pickup_placeholder: "Si puede irse solo/a, o solo lo recogen los tutores legales, deja este campo en blanco.",
                conditions_accepted_label: "He le√≠do y acepto las",
                conditions_link: "condiciones de las extraescolares y acogida",
                submit_button: "Enviar Preinscripci√≥n",
                status_success: "¬°Preinscripci√≥n enviada correctamente! Gracias.",
                status_error_supabase_credentials: "Error de configuraci√≥n. Contacta con el administrador.",
                status_error_activity_required: "Debes seleccionar al menos una actividad extraescolar.",
                status_error_generic: "Error al enviar el formulario: {error}. Por favor, int√©ntalo de nuevo m√°s tarde.",
                image_auth_modal_title: "Informaci√≥n sobre Derechos de Imagen",
                image_auth_modal_content: `<p>En cumplimiento de la Ley Org√°nica 1/1982, de 5 de mayo, sobre el derecho al honor, a la intimidad personal y familiar y a la propia imagen, pedimos autorizaci√≥n a los padres o tutores legales de los menores de edad para el uso de la imagen obtenida con fotograf√≠as y/o v√≠deos realizados por nuestra entidad con la finalidad de exponerlas en nuestra web, en facebook e instagram.</p><p>Solicitamos el consentimiento y autorizaci√≥n a la AFA Escola Falguera, a hacer uso de las im√°genes obtenidas durante su participaci√≥n en las actividades extraescolares, publicadas en la p√°gina web o redes sociales.</p><p>A partir de la firma de este formulario usted autoriza expresamente el tratamiento de sus datos de car√°cter personal, para la finalidad especificada, por parte de la AFA Escola Falguera.</p>`,
                conditions_modal_title: "Condiciones de las Extraescolares y Acogida",
                conditions_modal_content: `<div class="space-y-3">
                    <h4 class="font-bold text-base">Precios y Pago</h4>
                    <ul class="list-disc list-inside text-sm">
                        <li>Actividades Generales (16:30h a 18:00h): <strong>20‚Ç¨/mes socios</strong>, <strong>25‚Ç¨/mes no socios</strong>.</li>
                        <li>Timbales: <strong>14‚Ç¨/mes socios</strong>, <strong>18‚Ç¨/mes no socios</strong>.</li>
                        <li>Descuento 2 actividades/semana (misma actividad): <strong>36‚Ç¨/mes socios</strong>, <strong>40‚Ç¨/mes no socios</strong>.</li>
                        <li>El pago es mensual, por transferencia bancaria a la cuenta <strong>ES22.0081.1604.7400.0103.8208</strong> antes del d√≠a 10 del mes.</li>
                        <li class="font-semibold text-red-600">¬°Importante! Indicar en el concepto el nombre del alumno/a y la actividad.</li>
                    </ul>
                    <h4 class="font-bold text-base pt-2">Condiciones Generales</h4>
                    <ol class="list-decimal list-inside space-y-2 text-sm">
                    <li>Para poder acceder a las extraescolares o acogida con el precio de socio, deb√©is estar al corriente del pago de la cuota de la AFA.</li>
                    <li>La inscripci√≥n del alumno en la actividad se formalizar√° entregando el formulario de inscripci√≥n directamente a la AFA, o bien por correo electr√≥nico a ampafalguera@hotmail.es, debidamente cumplimentado y firmado, conjuntamente con la declaraci√≥n responsable.</li>
                    <li>A partir de septiembre las solicitudes de alta y de baja de las actividades propuestas deber√°n entregarse a la AFA antes del d√≠a 20 del mes en curso (una vez superado este plazo, la baja NO ser√° efectiva hasta el mes siguiente y se deber√° abonar la cuota correspondiente). Se pueden enviar v√≠a e-mail o presencialmente en la oficina de la AFA.</li>
                    <li>Todas las actividades son de pago mensual, con transferencia bancaria a la cuenta del Banc Sabadell ES22.0081.1604.7400.0103.8208 antes del d√≠a 10 del mes en curso. ¬°Importante! Indicar en el concepto nombre del alumno y la actividad.</li>
                    <li>Si no hubiera un n√∫mero m√≠nimo de alumnos, la actividad no se podr√° realizar y se ofrecer√°n alternativas en la medida que sea posible.</li>
                    <li>Si las solicitudes superan el n√∫mero de plazas ofertadas, se tendr√° en cuenta el orden de inscripci√≥n.</li>
                    <li>No se descontar√° del precio ni se recuperar√° la no asistencia de los alumnos, ni los d√≠as de vacaciones y festivos seg√∫n el calendario escolar. Sin embargo, s√≠ son recuperables los d√≠as de clase no impartidos por causas atribuibles a la empresa de extraescolares.</li>
                    <li>Los impagos que se produzcan causar√°n la baja del alumno en todas las actividades extraescolares.</li>
                    <li>Es obligaci√≥n de los padres/tutores advertir en el formulario de inscripci√≥n de cualquier enfermedad, alergia o intolerancia que el alumno pudiera sufrir.</li>
                    <li>Las personas autorizadas para recoger al alumno de las extraescolares o acogida, ser√°n los padres/madres/tutores/as y personas autorizadas que figuren en el formulario de inscripci√≥n.</li>
                    <li>Se ha de respetar tanto a la persona responsable de la actividad, como a los compa√±eros y compa√±eras, materiales e infraestructuras. De no ser as√≠, la AFA podr√° decidir juntamente con la empresa de extraescolares, si alguien debe abandonar el grupo, a fin de preservar la buena marcha y el buen funcionamiento de la actividad.</li>
                    <li>Los usuarios de becas confirmadas, deber√°n informar a la AFA marcando la casilla en el formulario de inscripci√≥n, y entregando el documento correspondiente.</li>
                    <li>Las preinscripciones se har√°n del 10 al 14 de junio y del 10 al 20 de septiembre.</li>
                </ol></div>`
            }
        };

        const modal = document.getElementById('info-modal');
        const modalOverlay = document.querySelector('.modal-overlay');
        const modalContainer = document.querySelector('.modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');

        const openModal = (titleKey, contentKey) => {
            modalTitle.innerText = translations[currentLang][titleKey];
            modalContent.innerHTML = translations[currentLang][contentKey];
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalOverlay.classList.remove('opacity-0');
                modalContainer.classList.remove('scale-95');
            }, 10);
        };

        const closeModal = () => {
            modalOverlay.classList.add('opacity-0');
            modalContainer.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        };

        document.getElementById('image-info-btn').addEventListener('click', () => openModal('image_auth_modal_title', 'image_auth_modal_content'));
        document.getElementById('conditions-btn').addEventListener('click', () => openModal('conditions_modal_title', 'conditions_modal_content'));
        modalCloseBtn.addEventListener('click', closeModal);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
        
        const setLanguage = (lang) => {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-lang]').forEach(element => {
                const key = element.dataset.lang;
                if (translations[lang][key]) element.innerText = translations[lang][key];
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(element => {
                const key = element.dataset.langPlaceholder;
                if (translations[lang][key]) element.placeholder = translations[lang][key];
            });
            const caBtn = document.getElementById('lang-ca');
            const esBtn = document.getElementById('lang-es');
            
            if (lang === 'ca') {
                caBtn.classList.add('active');
                caBtn.classList.remove('text-gray-600');
                esBtn.classList.remove('active');
                esBtn.classList.add('text-gray-600');
            } else {
                esBtn.classList.add('active');
                esBtn.classList.remove('text-gray-600');
                caBtn.classList.remove('active');
                caBtn.classList.add('text-gray-600');
            }
            renderActivityCards();
        };

        const createActivityCard = (activity, studentNumber) => {
            const isEnglishClass = activity.value.includes('Angl√®s') && (activity.value.includes('Dimarts') || activity.value.includes('Dimecres'));
            
            return `
                <label class="activity-card flex flex-col justify-between p-3 rounded-lg hover:shadow-md cursor-pointer">
                    <input type="checkbox" name="activity_${studentNumber}" value="${activity.value}">
                    <span class="font-semibold text-gray-800 text-sm md:text-base" data-lang="${activity.langKey}"></span>
                    <span class="text-xs text-gray-500 mt-1">${activity.schedule}</span>
                    <span class="text-xs text-white bg-blue-500 rounded-full px-2 py-0.5 mt-2 self-start" data-lang="${activity.dayLangKey}"></span>
                    ${isEnglishClass ? '<span class="text-xs text-red-600 font-semibold mt-1" data-lang="english_payment_warning">‚ö†Ô∏è No es paga per AFA</span>' : ''}
                </label>
            `;
        }

        const renderActivityCards = () => {
            // Student 1 activities
            const infantil1Container = document.querySelector('#activities-infantil-1 .grid');
            const primaria1_1Container = document.querySelector('#activities-primaria1-1 .grid');
            const primaria2_1Container = document.querySelector('#activities-primaria2-1 .grid');

            infantil1Container.innerHTML = allActivities.infantil.map(activity => createActivityCard(activity, '1')).join('');
            primaria1_1Container.innerHTML = allActivities.primaria1.map(activity => createActivityCard(activity, '1')).join('');
            primaria2_1Container.innerHTML = allActivities.primaria2.map(activity => createActivityCard(activity, '1')).join('');

            // Student 2 activities
            const infantil2Container = document.querySelector('#activities-infantil-2 .grid');
            const primaria1_2Container = document.querySelector('#activities-primaria1-2 .grid');
            const primaria2_2Container = document.querySelector('#activities-primaria2-2 .grid');

            infantil2Container.innerHTML = allActivities.infantil.map(activity => createActivityCard(activity, '2')).join('');
            primaria1_2Container.innerHTML = allActivities.primaria1.map(activity => createActivityCard(activity, '2')).join('');
            primaria2_2Container.innerHTML = allActivities.primaria2.map(activity => createActivityCard(activity, '2')).join('');

            document.querySelectorAll('[data-lang]').forEach(element => {
                const key = element.dataset.lang;
                if (translations[currentLang][key]) element.innerText = translations[currentLang][key];
            });

            document.querySelectorAll('.activity-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    e.preventDefault();
                    const checkbox = card.querySelector('input[type="checkbox"]');
                    checkbox.checked = !checkbox.checked;
                    card.classList.toggle('selected', checkbox.checked);
                });
            });
        }

        document.getElementById('copy-iban-btn').addEventListener('click', (e) => {
            const iban = document.getElementById('iban-account').innerText;
            navigator.clipboard.writeText(iban).then(() => {
                e.target.innerText = translations[currentLang].payment_copied_iban;
                setTimeout(() => {
                    e.target.innerText = translations[currentLang].payment_copy_iban;
                }, 2000);
            });
        });

        document.getElementById('lang-ca').addEventListener('click', () => setLanguage('ca'));
        document.getElementById('lang-es').addEventListener('click', () => setLanguage('es'));
        
        document.addEventListener('DOMContentLoaded', () => {
            renderActivityCards();
            setLanguage('ca');
        });

        const student1Course = document.getElementById('student1-course');
        const student2Course = document.getElementById('student2-course');
        const form = document.getElementById('inscription-form');
        const statusMessage = document.getElementById('status-message');
        const submitButton = document.getElementById('submit-button');
        const submitText = document.getElementById('submit-text');
        const submitLoader = document.getElementById('submit-loader');

        const updateActivitiesForStudent = (studentNumber) => {
            const course = document.getElementById(`student${studentNumber}-course`).value;
            const infantil = document.getElementById(`activities-infantil-${studentNumber}`);
            const primaria1 = document.getElementById(`activities-primaria1-${studentNumber}`);
            const primaria2 = document.getElementById(`activities-primaria2-${studentNumber}`);
            
            [infantil, primaria1, primaria2].forEach(el => el.classList.remove('active'));
            
            // Clear selected activities for this student
            document.querySelectorAll(`input[name="activity_${studentNumber}"]`).forEach(input => {
                input.checked = false;
                input.closest('.activity-card').classList.remove('selected');
            });

            if (['I3', 'I4', 'I5'].includes(course)) {
                infantil.classList.add('active');
            } else if (['1PRI', '2PRI', '3PRI'].includes(course)) {
                primaria1.classList.add('active');
            } else if (['4PRI', '5PRI', '6PRI'].includes(course)) {
                primaria2.classList.add('active');
            }
        };

        student1Course.addEventListener('change', () => updateActivitiesForStudent('1'));
        student2Course.addEventListener('change', () => updateActivitiesForStudent('2'));

        // Add/Remove second student functionality
        document.getElementById('add-second-student').addEventListener('click', () => {
            document.getElementById('student-2-section').classList.remove('hidden');
            document.getElementById('student2-activities').classList.remove('hidden');
            document.getElementById('add-second-student').classList.add('hidden');
        });

        document.getElementById('remove-second-student').addEventListener('click', () => {
            document.getElementById('student-2-section').classList.add('hidden');
            document.getElementById('student2-activities').classList.add('hidden');
            document.getElementById('add-second-student').classList.remove('hidden');
            
            // Clear second student data
            document.getElementById('student2-name').value = '';
            document.getElementById('student2-surname').value = '';
            document.getElementById('student2-course').value = '';
            document.querySelectorAll('input[name="activity_2"]').forEach(input => {
                input.checked = false;
                input.closest('.activity-card').classList.remove('selected');
            });
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (SUPABASE_URL === "LA_TEVA_URL_DE_SUPABASE" || SUPABASE_KEY === "LA_TEVA_ANON_KEY_DE_SUPABASE") {
                showStatus(translations[currentLang].status_error_supabase_credentials, 'error');
                return;
            }

            try {
                 supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
            } catch (error) {
                console.error("Error initializing Supabase client:", error);
                showStatus(translations[currentLang].status_error_generic.replace('{error}', error.message), 'error');
                return;
            }
            
            // Check if at least one student has activities selected
            const selectedActivities1 = Array.from(document.querySelectorAll('input[name="activity_1"]:checked'));
            const selectedActivities2 = Array.from(document.querySelectorAll('input[name="activity_2"]:checked'));
            
            if (selectedActivities1.length === 0 && selectedActivities2.length === 0) {
                showStatus(translations[currentLang].status_error_activity_required, 'error');
                document.querySelector('[data-lang="activities_legend"]').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            setLoading(true);
            const formData = new FormData(form);
            const selectedActivities1Values = selectedActivities1.map(activity => activity.value);
            const selectedActivities2Values = selectedActivities2.map(activity => activity.value);
            
            // Prepare students data
            const students = [];
            
            // Student 1 (always present)
            if (formData.get('student1_name') && formData.get('student1_surname') && formData.get('student1_course')) {
                students.push({
                    name: formData.get('student1_name'),
                    surname: formData.get('student1_surname'),
                    course: formData.get('student1_course'),
                    activities: selectedActivities1Values
                });
            }
            
            // Student 2 (if added)
            if (formData.get('student2_name') && formData.get('student2_surname') && formData.get('student2_course')) {
                students.push({
                    name: formData.get('student2_name'),
                    surname: formData.get('student2_surname'),
                    course: formData.get('student2_course'),
                    activities: selectedActivities2Values
                });
            }
            
            const submissionData = {
                students: students,
                parent_name: formData.get('parent_name'), parent_dni: formData.get('parent_dni'), parent_phone_1: formData.get('parent_phone_1'),
                parent_phone_2: formData.get('parent_phone_2') || 'No informat', parent_email_1: formData.get('parent_email_1'), parent_email_2: formData.get('parent_email_2') || 'No informat',
                afa_member: formData.get('afa_member') === 'true', health_info: formData.get('health_info') || 'Cap',
                image_auth_consent: formData.get('image_auth_consent'), can_leave_alone: formData.get('can_leave_alone') === 'true',
                authorized_pickup: formData.get('authorized_pickup') || 'Cap persona addicional autoritzada.',
                conditions_accepted: formData.get('conditions_accepted') === 'on',
                form_language: currentLang,
            };
            try {
                const { data, error } = await supabaseClient.from('inscripcions').insert([submissionData]);
                if (error) throw error;
                showStatus(translations[currentLang].status_success, 'success');
                form.reset();
                
                // Reset activities sections
                document.querySelectorAll('.form-section').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.activity-card.selected').forEach(c => c.classList.remove('selected'));
                
                // Hide second student if visible
                document.getElementById('student-2-section').classList.add('hidden');
                document.getElementById('student2-activities').classList.add('hidden');
                document.getElementById('add-second-student').classList.remove('hidden');
            } catch (error) {
                console.error('Error submitting to Supabase:', error);
                showStatus(translations[currentLang].status_error_generic.replace('{error}', error.message), 'error');
            } finally {
                setLoading(false);
            }
        });
        
        function setLoading(isLoading) {
            submitButton.disabled = isLoading;
            submitText.classList.toggle('hidden', isLoading);
            submitLoader.classList.toggle('hidden', !isLoading);
        }

        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `mt-6 text-center p-3 rounded-lg ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            setTimeout(() => {
                statusMessage.textContent = '';
                statusMessage.className = 'mt-6 text-center';
            }, 10000);
        }
    </script>
</body>
</html>

